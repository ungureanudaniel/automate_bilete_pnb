<!DOCTYPE html>
<html>
<head>
    <title>Automate Bilete Dashboard</title>
</head>
<body>
    <h1>üì° POS Heartbeat Monitor</h1>
    
    <div class="stats">
        <span>Total: {{ total }}</span> | 
        <span class="online">‚úÖ Online: {{ online }}</span> | 
        <span class="offline">‚ùå Offline: {{ offline }}</span>
    </div>
    
    <a href="#" onclick="pingNow()" class="btn">üîÑ Ping Now</a>
    
    <table>
        <tr>
            <th>POS ID</th>
            <th>IP Address</th>
            <th>Status</th>
            <th>Last Online</th>
            <th>Actions</th>
        </tr>
        {% for m in machines %}
        <tr>
            <td>{{ m.pos_id }}</td>
            <td>{{ m.ip_address }}</td>
            <td class="{% if m.is_online %}online{% else %}offline{% endif %}">
                {% if m.is_online %}‚úÖ ONLINE{% else %}‚ùå OFFLINE{% endif %}
            </td>
            <td>{{ m.last_online|timesince }} ago</td>
            <td>
                <button onclick="pingMachine({{ m.pos_id }})">Ping</button>
            </td>
        </tr>
        {% endfor %}
    </table>
    <h1>Dashboard (Last 24h)</h1>
    <table border="1">
        <tr>
            <th>POS ID</th>
            <th>Total Tickets</th>
            <th>Total Amount</th>
            <th>Transactions</th>
        </tr>
        {% for s in stats %}
        <tr>
            <td>{{ s.pos_id }}</td>
            <td>{{ s.pos_id }}</td>
            <td>{{ s.total_bilete }}</td>
            <td>{{ s.total_suma }}</td>
            <td>{{ s.tranzactii }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No transactions in last 24h</td></tr>
        {% endfor %}
    </table>

<div style="display: flex; margin-top:100px; height:400px; width:auto; flex-wrap: wrap; justify-content: space-around; gap: 20px;">
    <canvas id="ticketsPerPOS" width="400" height="200"></canvas>
    <canvas id="ticketsByProduct" width="300" height="300"></canvas>
    <canvas id="paperChart" width="400" height="200"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
        function pingNow() {
            fetch('/monitoring/ping-now/')
                .then(response => response.json())
                .then(data => {
                    alert('Ping completed: ' + data.message);
                    location.reload();
                });
        }
        
        function pingMachine(posId) {
            fetch(`/monitoring/ping-machine/${posId}/`)
                .then(() => location.reload());
        }
    </script>
<script>
const posLabels = {{ pos_labels_json|safe }};
const posTickets = {{ pos_tickets_json|safe }};
const productLabels = {{ product_labels_json|safe }};
const productValues = {{ product_values_json|safe }};
const paperLabels = {{ paper_labels_json|safe }};
const paperRemaining = {{ paper_remaining_json|safe }};
const paperColors = {{ paper_colors_json|safe }};

// --- Tickets per POS ---
new Chart(document.getElementById('ticketsPerPOS').getContext('2d'), {
    type: 'bar',
    data: {
        labels: posLabels,
        datasets: [{
            label: 'Tickets Sold',
            data: posTickets,
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: true } }
    }
});

// --- Tickets by Product ---
new Chart(document.getElementById('ticketsByProduct').getContext('2d'), {
    type: 'pie',
    data: {
        labels: productLabels,
        datasets: [{
            label: 'Tickets Sold',
            data: productValues,
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true } }
    }
});

// --- Paper Remaining ---
new Chart(document.getElementById('paperChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: paperLabels,
        datasets: [{
            label: 'Paper Remaining (%)',
            data: paperRemaining,
            backgroundColor: paperColors
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                min: 0,
                max: 100,
                title: { display: true, text: 'Percentage Remaining' }
            }
        },
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(ctx) { return ctx.raw.toFixed(1) + '% remaining'; }
                }
            }
        }
    }
});
</script>

</body>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    
    .chart-container {
        display: flex;
        flex-wrap: wrap;       /* allow wrapping on smaller screens */
        justify-content: center;
        gap: 20px;
    }

    canvas {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 6px;
        width: 100% !important;  /* full width of parent container */
        max-width: 400px;        /* limit width */
        min-height: 200px;       /* ensure visible height */
    }

    #ticketsByProduct {
        max-width: 300px;       /* optional: smaller pie chart */
        min-height: 250px;
    }

    @media (max-width: 900px) {
        canvas { max-width: 90%; } /* shrink charts on narrow screens */
    }
</style>

</html>